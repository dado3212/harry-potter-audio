<!doctype html>
<meta charset="utf-8" />
<title>Harry Potter - Movie Clips</title>
<style>
  :root{
    --bg:#0f1226; --bg2:#131735; --card:#171b3d; --text:#e9ecf1;
    --muted:#9aa3b2; --accent:#6ee7b7; --accent2:#22d3ee; --ring:rgba(110,231,183,.45);
    --w: 920px;
  }
  html,body{height:auto}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1200px 800px at 20% -10%, rgba(34,211,238,.25), transparent 60%),
      radial-gradient(1000px 700px at 120% 0%, rgba(110,231,183,.18), transparent 60%),
      linear-gradient(180deg, var(--bg), var(--bg2));
    background-attachment: fixed,fixed,fixed;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    display:flex; justify-content:center; padding:32px 24px 160px;
  }
  .wrap{width:100%; max-width:var(--w); display:grid; gap:14px}
  h1{margin:0 0 4px; text-align:center; letter-spacing:.3px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.08); border-radius:14px; backdrop-filter:blur(6px);
    box-shadow: 0 12px 28px rgba(0,0,0,.35);
  }
  .toolbar{display:flex; gap:10px; align-items:center; justify-content:center; padding:12px}
  button{
    border:1px solid rgba(255,255,255,.12); border-radius:12px; cursor:pointer;
    background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    color:var(--text); padding:10px 14px; transition:transform .05s, border-color .2s, filter .2s;
  }
  button.primary{background:linear-gradient(180deg, var(--accent), var(--accent2)); color:#0b1024; border-color:transparent; font-weight:600}
  button:hover{border-color:rgba(255,255,255,.28)}
  button.primary:hover{filter:brightness(1.05)}
  button:active{transform:translateY(1px)}
  button:disabled{opacity:.55; cursor:not-allowed}
  .vidwrap{padding:14px; display:flex; justify-content:center}
  video{
    width:100%; max-width:100%; max-height:60vh; background:#0b0f26; border-radius:14px;
    border:1px solid rgba(255,255,255,.08); box-shadow:0 18px 40px rgba(5,8,25,.55)
  }
  .info{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px}
  .label{opacity:.9}
  .hint{color:var(--muted); font-size:13px}
  .progress{height:10px; width:100%; background:#0e1430; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.08)}
  .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2))}
</style>

<div class="wrap">
  <h1>Harry Potter - Movie Clips</h1>

  <div class="card toolbar">
    <button id="btnEasy" class="primary">Easy - 15s</button>
    <button id="btnMedium" class="primary">Medium - 10s</button>
    <button id="btnHard" class="primary">Hard - 5s</button>
    <button id="btnImpossible" class="primary">Impossible - 1s</button>
  </div>

  <div class="card vidwrap">
    <video id="vid" playsinline></video>
  </div>

  <div class="card info">
    <div class="progress"><div id="bar" class="bar"></div></div>
    <button id="btnReplay">Replay</button>
  </div>
</div>
<script src="config.local.js"></script>
<script>
  const vid = document.getElementById('vid');

  const btnEasy = document.getElementById('btnEasy');
  const btnMedium = document.getElementById('btnMedium');
  const btnHard = document.getElementById('btnHard');
  const btnImpossible = document.getElementById('btnImpossible');

  const btnReplay = document.getElementById('btnReplay');
  const lenEl = document.getElementById('len');
  const bar = document.getElementById('bar');

  let current = null;      // {movie,start,end,len}
  let rafId = null;

  const pick = a => a[Math.floor(Math.random()*a.length)];
  const label = m => `${m.title}${m.year ? ` (${m.year})` : ""}`;

  async function ensureMeta(url){
    if (vid.src !== url){
      vid.src = url;
      await vid.play().catch(()=>{});
      vid.pause();
      if (vid.readyState < 1) await new Promise(r => vid.addEventListener('loadedmetadata', r, { once:true }));
    }
  }

  async function playRandomClip(len) {
    cancelAnim();
    const movie = pick(window.MOVIES);
    await ensureMeta(movie.url);
    const dur = isFinite(vid.duration) ? vid.duration : (movie.duration ? movie.duration/1000 : 600);
    const safe = Math.max(0, dur*0.90 - len);
    const start = Math.random()*safe + dur*0.05;
    current = { movie, start, end: start+len, len };
    await seek(start);
    vid.play();
    loop();
  }

  async function replayClip(){
    if (!current) return;
    cancelAnim();
    await seek(current.start);
    vid.play();
    loop();
  }

  function seek(t){
    return new Promise(r=>{
      vid.currentTime = t;
      if (vid.seeking || vid.readyState < 2) vid.addEventListener('seeked', r, { once:true });
      else r();
    });
  }

  function loop(){
    const step = () => {
      if (!current) return;
      const total = current.end - current.start;
      const elapsed = Math.max(0, Math.min(total, vid.currentTime - current.start));
      bar.style.width = `${(elapsed/total)*100}%`;
      if (vid.currentTime >= current.end - 0.02){ vid.pause(); cancelAnim(); }
      else rafId = requestAnimationFrame(step);
    };
    rafId = requestAnimationFrame(step);
  }
  function cancelAnim(){ if (rafId){ cancelAnimationFrame(rafId); rafId = null; bar.style.width='0%'; } }

  btnEasy.onclick = () => playRandomClip(15);
  btnMedium.onclick = () => playRandomClip(10);
  btnHard.onclick = () => playRandomClip(5);
  btnImpossible.onclick = () => playRandomClip(1);

  btnReplay.onclick = replayClip;
  // btnReveal.onclick = reveal;
</script>