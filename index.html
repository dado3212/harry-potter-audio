<!doctype html>

  <title>Harry Potter Blind Guess</title>

  <!-- Meta tags -->
  <meta name="robots" content="index, follow, archive">
  <meta name="description" content="Can you correctly match a Harry Potter audio snippet to the movie it's from?  See how well you really know the movies!">
  <meta charset="utf-8" />
  <meta http-equiv="Cache-control" content="public">

  <!-- SEO and Semantic Markup -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:creator" content="@alex_beals">

  <!-- Fix for FB crawler bugs -->
  <meta property="og:title" content="Harry Potter Blind Guess">
  <meta property="og:type" content="website">
  <meta property="og:image" content="http://alexbeals.com/projects/harry-potter-audio/preview.png">
  <meta property="og:url" content="http://alexbeals.com/projects/harry-potter-audio/">
  <meta property="og:description" content="Can you correctly match a Harry Potter audio snippet to the movie it's from?  See how well you really know the movies!">

<style>
  :root{
    --bg:#0f1226; --bg2:#131735; --card:#171b3d; --text:#e9ecf1;
    --muted:#9aa3b2; --accent:#6ee7b7; --accent2:#22d3ee; --ring:rgba(110,231,183,.45);
    --w: 980px;
  }
  html,body{height:auto}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1200px 800px at 20% -10%, rgba(34,211,238,.25), transparent 60%),
      radial-gradient(1000px 700px at 120% 0%, rgba(110,231,183,.18), transparent 60%),
      linear-gradient(180deg, var(--bg), var(--bg2));
    background-attachment: fixed,fixed,fixed;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    display:flex; justify-content:center; padding:32px 24px;
  }
  .wrap{width:100%; max-width:var(--w);}
  h1{margin:0 0 6px; text-align:center; letter-spacing:.3px}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.08); border-radius:14px; backdrop-filter:blur(6px);
    box-shadow: 0 12px 28px rgba(0,0,0,.35);
    margin: 20px;
  }
  .toolbar{display:flex; gap:10px; align-items:center; justify-content:center; padding:12px}
  button{
    border:1px solid rgba(255,255,255,.12); border-radius:12px; cursor:pointer;
    background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    color:var(--text); padding:10px 14px; transition:transform .05s, border-color .2s, filter .2s;
  }
  button.primary{background:linear-gradient(180deg, var(--accent), var(--accent2)); color:#0b1024; border-color:transparent; font-weight:600}
  button:hover{border-color:rgba(255,255,255,.28)}
  button.primary:hover{filter:brightness(1.05)}
  button:active{transform:translateY(1px)}
  button:disabled{opacity:.55; cursor:not-allowed}

  .posterGrid{display: flex; gap:12px; padding:14px}
  .poster{
    position:relative; border-radius:12px; overflow:hidden; cursor:pointer;
    background:#0b0f26; border:1px solid rgba(255,255,255,.10);
    transition:transform .18s ease, box-shadow .2s ease, filter .2s ease;
    width: 12%;
  }
  .poster img{width:100%; height:100%; object-fit:cover; display:block}
  .poster:hover{transform:translateY(-2px); box-shadow:0 10px 22px rgba(0,0,0,.35)}
  .poster.incorrect{filter:grayscale(1) brightness(.6); pointer-events:none}
  .poster.correct{box-shadow:0 0 0 3px var(--ring) inset}

  .vidwrap{padding: 0px; max-height: 0; justify-content:center; transition: 1s ease; overflow: hidden; border: 0px; margin-top:-20px;}
  .vidwrap.show{padding:14px; max-height: 60vh; border: 1px solid rgba(255,255,255,.08); margin: 20px;}
  video{
    width:100%; max-width:100%; max-height:60vh; background:#0b0f26; border-radius:14px;
    border:1px solid rgba(255,255,255,.08); box-shadow:0 18px 40px rgba(5,8,25,.55)
  }

  .info{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px}
  .progress{height:10px; width:100%; background:#0e1430; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.08)}
  .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2))}

  .titleRow{display:flex; align-items:center; justify-content:center; gap:10px; padding:10px 12px}
  .label{opacity:.95}
  .muted{color:var(--muted); font-size:13px}

  .cloneAnim{position:fixed; z-index:9999; border-radius:12px; overflow:hidden; box-shadow:0 10px 28px rgba(0,0,0,.45)}
</style>

<div class="wrap">
  <h1>Harry Potter Blind Guess</h1>

  <div class="card" style="text-align: center;">
    <div class="toolbar">
      <button id="b15" class="primary">Easy 路 15s</button>
      <button id="b10" class="primary">Medium 路 10s</button>
      <button id="b5"  class="primary">Hard 路 5s</button>
      <button id="b1"  class="primary">Impossible 路 1s</button>
    </div>
    <div class="label" id="status" style="margin: 0 0 10px 0;">Pick a difficulty to play an audio clip. Then guess the movie!</div>
  </div>

  <div class="card vidwrap" id="videoCard" aria-hidden="true">
    <video id="vid" playsinline controls></video>
  </div>

  <div class="card info">
    <div class="progress"><div id="bar" class="bar"></div></div>
    <button id="replay">Replay</button>
  </div>

  <div class="card posterGrid" id="grid"></div>
  <canvas id="confetti-canvas" style="display: none;"></canvas>
</div>

<script src="config.local.js"></script>
<script>
  const grid = document.getElementById('grid');
  const videoCard = document.getElementById('videoCard');
  const vid = document.getElementById('vid');
  const bar = document.getElementById('bar');
  const statusEl = document.getElementById('status');

  // For confetti when guessing correctly
  const canvas = document.getElementById('confetti-canvas');
  let stopConfetti = false;
  let fadeOut = false;
  window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  });

  const btns = { b15:15, b10:10, b5:5, b1:1 };
  Object.entries(btns).forEach(([id,len]) => {
    document.getElementById(id).onclick = () => startRound(len);
  });
  document.getElementById('replay').onclick = replayClip;

  const MOVIES = Array.isArray(window.MOVIES) ? window.MOVIES : [];

  let target = null;       // movie object
  let current = null;      // {movie,start,end,len}
  let raf = 0;

  renderGrid();

  function renderGrid() {
    grid.innerHTML = '';
    MOVIES.forEach(m => {
      const d = document.createElement('div');
      d.className = 'poster';
      d.dataset.title = m.title;
      const img = new Image();
      img.src = m.poster;
      img.alt = m.title;
      d.appendChild(img);
      d.onclick = () => onGuess(d, m);
      grid.appendChild(d);
    });
  }

  function pick(a){ return a[Math.floor(Math.random()*a.length)] }

  async function ensureMeta(url){
    if (vid.src !== url){
      vid.src = url;
      await vid.play().catch(()=>{});
      vid.pause();
      if (vid.readyState < 1) await new Promise(r => vid.addEventListener('loadedmetadata', r, { once:true }));
    }
  }

  async function startRound(len){
    resetUI();
    target = pick(MOVIES);
    await ensureMeta(target.url);
    vid.muted = false;
    vid.volume = 1;

    const dur = isFinite(vid.duration) ? vid.duration : (target.duration ? target.duration/1000 : 600);
    const safe = Math.max(0, dur*0.90 - len);
    const start = Math.random()*safe + dur*0.05;

    current = { movie: target, start, end: start+len, len };
    statusEl.textContent = `Guess the movie by audio.`;
    await seek(start);
    vid.play();
    loop();
  }

  function resetUI(){
    cancelLoop();
    bar.style.width = '0%';
    videoCard.style.transition = 'none';
    videoCard.classList.remove('show');
    videoCard.setAttribute('aria-hidden','true');
    setTimeout(() => {
      videoCard.style.transition = '1s ease';
    }, 10);
    Array.from(grid.children).forEach(el => el.classList.remove('incorrect','correct'));
  }

  function seek(t){
    return new Promise(r=>{
      vid.currentTime = t;
      if (vid.seeking || vid.readyState < 2) vid.addEventListener('seeked', r, { once:true });
      else r();
    });
  }

  function loop(){
    const step = () => {
      if (!current) return;
      const total = current.end - current.start;
      const elapsed = Math.max(0, Math.min(total, vid.currentTime - current.start));
      bar.style.width = `${(elapsed/total)*100}%`;
      if (vid.currentTime >= current.end - 0.02){ vid.pause(); cancelLoop(); }
      else raf = requestAnimationFrame(step);
    };
    raf = requestAnimationFrame(step);
  }
  function cancelLoop(){ if (raf){ cancelAnimationFrame(raf); raf = 0; } }

  async function replayClip(){
    if (!current) return;
    cancelLoop();
    await seek(current.start);
    vid.play();
    loop();
  }

  function onGuess(tile, movie){
    if (!current) return;

    // Highlight the correct one
    document.querySelectorAll('.poster').forEach(x => {
      x.classList.add(x.dataset.title === current.movie.title ? 'correct' : 'incorrect');
    });
    // Confetti!
    if (movie.title === current.movie.title) {
      const ctx = canvas.getContext('2d');
      canvas.style.position = 'fixed';
      canvas.style.top = 0;
      canvas.style.display = 'block';
      canvas.style.left = 0;
      canvas.style.pointerEvents = 'none';
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const confettiCount = 150;
      const confetti = [];

      for (let i = 0; i < confettiCount; i++) {
        const gryffindorColor = () =>  {
          const redRange = [0, 20];
          const goldRange = [40, 50];
          const range = Math.random() < 0.5 ? redRange : goldRange;
          const hue = range[0] + Math.random() * (range[1] - range[0]);
          return `hsl(${hue}, 100%, 50%)`;
        };
        confetti.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          r: Math.random() * 6 + 4,
          d: Math.random() * confettiCount,
          color: gryffindorColor(),
          tilt: Math.random() * 10 - 10,
          tiltAngleIncrement: Math.random() * 0.07 + 0.05,
          tiltAngle: 0,
          opacity: 1,
        });
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        confetti.forEach(c => {
          ctx.beginPath();
          ctx.lineWidth = c.r;
          ctx.strokeStyle = c.color.replace('hsl', 'hsla').replace(')', `, ${c.opacity})`);
          ctx.moveTo(c.x + c.tilt + c.r / 2, c.y);
          ctx.lineTo(c.x + c.tilt, c.y + c.tilt + c.r / 2);
          ctx.stroke();
        });

        update();
        if (!stopConfetti) {
          requestAnimationFrame(draw);
        } else {
          canvas.style.display = 'none';
        }
      }

      function update() {
        confetti.forEach(c => {
          c.y += Math.cos(c.d) + 2 + c.r / 2;
          c.x += Math.sin(c.d);
          c.tiltAngle += c.tiltAngleIncrement;
          c.tilt = Math.sin(c.tiltAngle) * 15;

          if (fadeOut) {
            c.opacity = c.opacity * 0.95;
          }

          // Don't loop
          // if (c.y > canvas.height) {
          //   c.y = -30;
          //   c.x = Math.random() * canvas.width;
          // }
        });
      }

      stopConfetti = false;
      fadeOut = false;
      draw();

      setTimeout(() => {
        fadeOut = true;
      }, 1500);
      setTimeout(() => {
        stopConfetti = true;
      }, 2000);
    }

    statusEl.textContent = `${current.movie.title} (${current.movie.year})`;

    // No matter what after a second expand the video and play the audio
    setTimeout(() => {
      videoCard.classList.add('show');
      videoCard.setAttribute('aria-hidden','false');
      vid.controls = true;
      replayClip();
    }, 1000);
  }
</script>